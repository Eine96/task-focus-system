<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èšç„¦ä»»åŠ¡ç³»ç»Ÿ Pro v3 (å·²ä¿å­˜)</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* CSSæ ·å¼ä¸ä¹‹å‰ç‰ˆæœ¬ç›¸åŒï¼Œæ­¤å¤„ä¸ºç®€æ´çœç•¥ï¼Œå®é™…ä½¿ç”¨æ—¶è¯·ä¿ç•™ä¹‹å‰çš„CSSä»£ç  */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 600px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #111; }
        #setup-screen .input-group { display: flex; margin-bottom: 20px; }
        #setup-screen input { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px 0 0 8px; font-size: 16px; }
        #setup-screen #add-task-btn { padding: 12px 20px; border: none; background: #007bff; color: white; font-size: 16px; border-radius: 0 8px 8px 0; cursor: pointer; }
        #task-list { list-style: none; padding: 0; }
        #task-list li { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; cursor: move; font-size: 18px; }
        #task-list li .delete-btn { background: transparent; border: none; color: #dc3545; font-size: 20px; cursor: pointer; display: none; }
        #task-list li:hover .delete-btn { display: block; }
        .start-btn { display: block; width: 100%; padding: 15px; font-size: 18px; background: #28a745; color: white; border-radius: 8px; border: none; cursor: pointer; margin-top: 20px;}
        .start-btn:disabled { background: #aaa; }
        #task-screen { display: none; text-align: center; }
        #current-task-text { font-size: 28px; font-weight: 500; padding: 20px; margin: 20px 0; border: 2px dashed #ddd; border-radius: 8px; min-height: 50px; }
        #current-task-text:focus { background: #f0f8ff; outline: none; border-color: #007bff; }
        .timer-group { margin: 30px 0; }
        .timer-group input { width: 60px; text-align: center; font-size: 16px; padding: 8px; border-radius: 8px; border: 1px solid #ddd; margin: 0 10px;}
        .timer-group button { padding: 8px 16px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; }
        #timer-display { font-size: 48px; font-weight: bold; color: #007bff; margin: 20px 0; }
        #complete-btn { display: block; width: 100%; padding: 15px; font-size: 18px; background: #007bff; color: white; border-radius: 8px; border: none; cursor: pointer; margin-top: 20px;}
        .secondary-btn { display: block; width: 100%; padding: 10px; font-size: 16px; background: #6c757d; color: white; border-radius: 8px; border: none; cursor: pointer; margin-top: 10px; }
        #final-message { display: none; text-align: center; }
        #final-message p { font-size: 28px; font-weight: bold; color: #28a745; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    </style>
</head>
<body>
    <div class="container">
        <div id="setup-screen">
            <h1>è®¾ç½®ä½ çš„ä»»åŠ¡åˆ—è¡¨</h1>
            <div class="input-group">
                <input type="text" id="new-task-input" placeholder="è¾“å…¥ä¸€ä¸ªæ–°ä»»åŠ¡...">
                <button id="add-task-btn">+</button>
            </div>
            <ul id="task-list"></ul>
            <button id="start-tasks-btn" class="start-btn" disabled>å¼€å§‹ä»»åŠ¡</button>
        </div>
        <div id="task-screen">
            <h2>å½“å‰ä»»åŠ¡</h2>
            <div id="current-task-text" contenteditable="true" title="ç‚¹å‡»ä»¥ç¼–è¾‘"></div>
            <div class="timer-group">
                <label>è®¾å®šå€’è®¡æ—¶ (åˆ†é’Ÿ):</label>
                <input type="number" id="timer-input" value="25" min="1">
                <button id="start-timer-btn">å¼€å§‹è®¡æ—¶</button>
            </div>
            <div id="timer-display">--:--</div>
            <button id="complete-btn" class="complete-btn">å®Œæˆä»»åŠ¡</button>
            <button id="back-to-list-btn" class="secondary-btn">è¿”å›åˆ—è¡¨ä¿®æ”¹</button>
        </div>
        <div id="final-message">
            <p>ğŸ‰ æ­å–œï¼æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼</p>
            <button id="restart-btn" class="start-btn">åˆ›å»ºæ–°åˆ—è¡¨</button>
        </div>
    </div>
    <canvas id="confetti-canvas"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- å…¨å±€å˜é‡å’ŒçŠ¶æ€ ---
            let tasks = [];
            let currentTaskIndex = 0;
            let timerInterval = null;

            // --- è·å–å…ƒç´  ---
            // (æ­¤éƒ¨åˆ†ä¸ä¸Šä¸€ç‰ˆç›¸åŒï¼Œä¿æŒä¸å˜)
            const setupScreen = document.getElementById('setup-screen');
            const taskScreen = document.getElementById('task-screen');
            const finalMessage = document.getElementById('final-message');
            const newTaskInput = document.getElementById('new-task-input');
            const addTaskBtn = document.getElementById('add-task-btn');
            const taskList = document.getElementById('task-list');
            const startTasksBtn = document.getElementById('start-tasks-btn');
            const currentTaskText = document.getElementById('current-task-text');
            const timerInput = document.getElementById('timer-input');
            const startTimerBtn = document.getElementById('start-timer-btn');
            const timerDisplay = document.getElementById('timer-display');
            const completeBtn = document.getElementById('complete-btn');
            const backToListBtn = document.getElementById('back-to-list-btn');
            const restartBtn = document.getElementById('restart-btn');
            
            // --- åˆå§‹åŒ– Confetti ç‰¹æ•ˆ ---
            const myConfetti = confetti.create(document.getElementById('confetti-canvas'), { resize: true, useWorker: true });

            // --- ã€æ–°å¢ã€‘LocalStorage æ ¸å¿ƒåŠŸèƒ½ ---
            const STORAGE_KEY = 'focusTaskAppState';

            function saveState(view = 'setup') {
                const state = {
                    tasks: Array.from(taskList.children).map(li => li.childNodes[0].textContent.trim()),
                    currentTaskIndex: currentTaskIndex,
                    currentView: view
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }

            function loadState() {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (!savedState) return;

                const state = JSON.parse(savedState);
                
                // æ¢å¤ä»»åŠ¡åˆ—è¡¨åˆ°DOM
                taskList.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ—è¡¨
                state.tasks.forEach(taskText => {
                    createTaskLi(taskText); // ä½¿ç”¨ä¸€ä¸ªæ–°å‡½æ•°æ¥åˆ›å»ºLIå…ƒç´ 
                });

                tasks = state.tasks;
                currentTaskIndex = state.currentTaskIndex;
                updateStartButtonState();
                
                // æ¢å¤è§†å›¾
                if (state.currentView === 'task' && tasks.length > 0 && currentTaskIndex < tasks.length) {
                    setupScreen.style.display = 'none';
                    taskScreen.style.display = 'block';
                    displayCurrentTask();
                }
            }

            function clearState() {
                localStorage.removeItem(STORAGE_KEY);
            }

            // --- ä»»åŠ¡è®¾ç½®å±å¹•é€»è¾‘ ---
            
            // ã€ä¿®æ”¹ã€‘å°†åˆ›å»ºLIçš„é€»è¾‘æå–ä¸ºç‹¬ç«‹å‡½æ•°ï¼Œæ–¹ä¾¿æ¢å¤çŠ¶æ€æ—¶è°ƒç”¨
            function createTaskLi(taskText) {
                const li = document.createElement('li');
                li.textContent = taskText;
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Ã—';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = () => { 
                    li.remove(); 
                    updateStartButtonState();
                    saveState('setup'); // ã€ä¿å­˜ã€‘åˆ é™¤åä¿å­˜çŠ¶æ€
                };
                li.appendChild(deleteBtn);
                taskList.appendChild(li);
            }

            function addTask() {
                const taskText = newTaskInput.value.trim();
                if (taskText === '') return;
                createTaskLi(taskText);
                newTaskInput.value = '';
                newTaskInput.focus();
                updateStartButtonState();
                saveState('setup'); // ã€ä¿å­˜ã€‘æ·»åŠ åä¿å­˜çŠ¶æ€
            }
            
            addTaskBtn.addEventListener('click', addTask);
            newTaskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTask(); });

            function updateStartButtonState() {
                startTasksBtn.disabled = taskList.children.length === 0;
            }

            // ã€ä¿®æ”¹ã€‘åˆå§‹åŒ–æ‹–æ‹½æ’åºï¼Œå¹¶åœ¨ç»“æŸæ—¶ä¿å­˜çŠ¶æ€
            new Sortable(taskList, {
                animation: 150,
                ghostClass: 'blue-background-class',
                onEnd: () => {
                    saveState('setup'); // ã€ä¿å­˜ã€‘æ‹–æ‹½ç»“æŸåä¿å­˜çŠ¶æ€
                }
            });

            startTasksBtn.addEventListener('click', () => {
                tasks = Array.from(taskList.children).map(li => li.childNodes[0].textContent.trim());
                if (tasks.length > 0) {
                    currentTaskIndex = 0;
                    setupScreen.style.display = 'none';
                    taskScreen.style.display = 'block';
                    displayCurrentTask();
                    saveState('task'); // ã€ä¿å­˜ã€‘å¼€å§‹ä»»åŠ¡æ—¶ä¿å­˜çŠ¶æ€
                }
            });

            // --- èšç„¦ä»»åŠ¡å±å¹•é€»è¾‘ ---
            function displayCurrentTask() {
                if (currentTaskIndex < tasks.length) {
                    currentTaskText.textContent = tasks[currentTaskIndex];
                    timerDisplay.textContent = '--:--';
                    timerInput.value = 25;
                } else {
                    taskScreen.style.display = 'none';
                    finalMessage.style.display = 'block';
                    clearState(); // ã€æ¸…é™¤ã€‘æ‰€æœ‰ä»»åŠ¡å®Œæˆåæ¸…é™¤çŠ¶æ€
                }
            }
            
            currentTaskText.addEventListener('blur', () => {
                if (tasks[currentTaskIndex] && tasks[currentTaskIndex] !== currentTaskText.textContent) {
                    tasks[currentTaskIndex] = currentTaskText.textContent;
                     // æ›´æ–°DOMä¸­çš„liæ–‡æœ¬ï¼Œä»¥ä¾¿è¿”å›æ—¶èƒ½çœ‹åˆ°ä¿®æ”¹
                    taskList.children[currentTaskIndex].childNodes[0].textContent = currentTaskText.textContent;
                    saveState('task'); // ã€ä¿å­˜ã€‘ç¼–è¾‘ä»»åŠ¡åä¿å­˜çŠ¶æ€
                }
            });

            startTimerBtn.addEventListener('click', () => { /* ... æ­¤å¤„é€»è¾‘ä¸å˜ ... */ });
            // (å®šæ—¶å™¨é€»è¾‘ä¸ä¸Šä¸€ç‰ˆç›¸åŒï¼Œä¿æŒä¸å˜)
            startTimerBtn.addEventListener('click', () => {
                const minutes = parseInt(timerInput.value, 10);
                if (isNaN(minutes) || minutes <= 0) return;
                let totalSeconds = minutes * 60;
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    if (totalSeconds <= 0) {
                        clearInterval(timerInterval);
                        timerDisplay.textContent = "æ—¶é—´åˆ°!";
                        return;
                    }
                    totalSeconds--;
                    const min = Math.floor(totalSeconds / 60);
                    const sec = totalSeconds % 60;
                    timerDisplay.textContent = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                }, 1000);
            });
            
            completeBtn.addEventListener('click', () => {
                clearInterval(timerInterval);
                myConfetti({ particleCount: 150, spread: 180, origin: { y: 0.6 } });
                setTimeout(() => {
                    currentTaskIndex++;
                    displayCurrentTask();
                    if(currentTaskIndex < tasks.length) {
                       saveState('task'); // ã€ä¿å­˜ã€‘å®Œæˆä¸€ä¸ªä»»åŠ¡åä¿å­˜æ–°çŠ¶æ€
                    }
                }, 1500);
            });

            // --- è¿”å›å’Œé‡ç½®é€»è¾‘ ---
            function goBackToList() {
                clearInterval(timerInterval);
                taskScreen.style.display = 'none';
                setupScreen.style.display = 'block';
                saveState('setup'); // ã€ä¿å­˜ã€‘è¿”å›åˆ—è¡¨æ—¶ä¿å­˜çŠ¶æ€
            }
            
            function restart() {
                taskList.innerHTML = ''; 
                tasks = [];
                currentTaskIndex = 0;
                finalMessage.style.display = 'none';
                setupScreen.style.display = 'block';
                updateStartButtonState();
                clearState(); // ã€æ¸…é™¤ã€‘ç‚¹å‡»é‡æ–°å¼€å§‹æ—¶æ¸…é™¤çŠ¶æ€
            }

            backToListBtn.addEventListener('click', goBackToList);
            restartBtn.addEventListener('click', restart);

            // --- ã€å¯åŠ¨ã€‘é¡µé¢åŠ è½½æ—¶ï¼Œè‡ªåŠ¨åŠ è½½ä¸Šæ¬¡çš„çŠ¶æ€ ---
            loadState();
        });
    </script>
</body>
</html>